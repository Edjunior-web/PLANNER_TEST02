<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner GM Caxias-MA | Oficial</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#293548', 850: '#172033', 950: '#0b1121' }
                    },
                    animation: {
                        blob: "blob 7s infinite",
                        'bounce-short': 'bounce 1s ease-in-out 3'
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" },
                        },
                    },
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .status-pendente { border-left: 4px solid #9ca3af; }
        .status-estudo { border-left: 4px solid #3b82f6; }
        .status-concluido { border-left: 4px solid #10b981; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .modal { transition: opacity 0.25s ease; z-index: 150 !important; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .dark .tab-active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .tab-inactive { color: #6b7280; }
        .dark .tab-inactive { color: #94a3b8; }

        .disc-card:hover { transform: translateY(-2px); border-color: #3b82f6; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
            pointer-events: all; 
        }
        .dark #loading-overlay { background: rgba(15, 23, 42, 0.95); }
        .hidden-force { display: none !important; pointer-events: none !important; }

        /* Streak Flame Animation */
        .flame-active { color: #f97316; filter: drop-shadow(0 0 5px rgba(249, 115, 22, 0.6)); animation: bounce-short 2s infinite; }
        .flame-inactive { color: #9ca3af; }

        /* Mission Card Animation */
        .mission-card { border-left: 4px solid #8b5cf6; background: linear-gradient(to right, rgba(139, 92, 246, 0.1), transparent); }
        
        /* Accordion Animations */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0; opacity: 0; overflow: hidden;
        }
        .accordion-content.open { max-height: 5000px; opacity: 1; }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion-icon.rotate { transform: rotate(180deg); }
    </style>
</head>
<body class="text-gray-800 bg-[#f3f4f6] dark:bg-slate-900 dark:text-gray-200">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="flex flex-col items-center justify-center">
        <i class="fa-solid fa-cloud-arrow-down fa-bounce text-4xl text-blue-600 dark:text-blue-400 mb-4"></i>
        <p class="text-sm text-gray-600 dark:text-gray-300 font-semibold" id="loading-text">Iniciando Planner...</p>
    </div>

    <!-- Navbar -->
    <nav class="bg-slate-900 dark:bg-slate-950 text-white shadow-lg sticky top-0 z-50 border-b border-transparent dark:border-slate-800 transition-colors duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-shield-halved text-yellow-500 text-2xl"></i>
                <div>
                    <h1 id="header-title" class="font-bold text-lg leading-tight">PC-PI 2026</h1>
                    <p id="header-subtitle" class="text-xs text-slate-400">Oficial Investigador</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <!-- Streak Indicator -->
                <div class="flex items-center gap-1 bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700 cursor-help" title="Ofensiva de Estudos">
                    <i class="fa-solid fa-fire text-lg flame-inactive transition-all" id="streak-icon"></i>
                    <span id="streak-count" class="font-bold text-lg text-gray-400">0</span>
                </div>

                <div class="hidden md:flex items-center gap-6 text-right">
                    <div class="cursor-pointer hover:bg-slate-800 dark:hover:bg-slate-900 p-1 rounded transition" onclick="openSyncModal()" title="Status da Conexão">
                        <p class="text-[10px] text-slate-400 uppercase tracking-wider flex items-center justify-end gap-1">
                            <i id="status-icon-desktop" class="fa-solid fa-wifi text-gray-400"></i> Status
                        </p>
                        <p id="header-sync-status" class="font-mono font-bold text-white text-sm tracking-wider">Verificando...</p>
                    </div>
                    <div><p class="text-[10px] text-slate-400 uppercase tracking-wider">Data da Prova</p><p id="header-date" class="font-bold text-white text-sm">25/01/2026</p></div>
                    <div><p class="text-[10px] text-slate-400 uppercase tracking-wider">Contagem</p><p id="countdown-desktop" class="font-bold text-yellow-400 text-sm">Calculando...</p></div>
                </div>
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-800 dark:bg-slate-900 hover:bg-slate-700 dark:hover:bg-slate-800 text-yellow-400 dark:text-blue-300 transition flex items-center justify-center border border-slate-700 dark:border-slate-800 shadow-sm"><i id="theme-icon" class="fa-solid fa-sun"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6 space-y-6">
        <!-- Countdown Mobile -->
        <div class="md:hidden bg-slate-800 dark:bg-slate-950 text-white p-3 rounded-lg text-sm shadow flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <span id="header-date-mobile" class="text-slate-400 text-xs">25/01/2026</span>
                <span>Prova em: <span id="countdown-mobile" class="font-bold text-yellow-400">...</span></span>
            </div>
            <div class="border-t border-slate-700 pt-2 flex justify-between items-center cursor-pointer" onclick="openSyncModal()">
                <span class="text-xs text-slate-400"><i id="status-icon-mobile" class="fa-solid fa-wifi text-gray-400 mr-1"></i> Conexão:</span>
                <span id="header-sync-status-mobile" class="font-mono font-bold text-white text-xs">Verificando...</span>
            </div>
        </div>

        <!-- Dashboard Section: Desafios e Progresso -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- CARD DE MISSÃO DIÁRIA -->
            <div class="lg:col-span-2 glass-panel rounded-xl p-4 flex flex-col relative overflow-hidden mission-card min-h-[200px]">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-scroll text-6xl text-purple-500"></i></div>
                
                <!-- Header com Botões de Configuração e PDF -->
                <div class="flex justify-between items-center mb-3 z-10 relative">
                    <h3 class="text-purple-600 dark:text-purple-400 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-calendar-day"></i> Missão de Hoje (<span id="mission-day-display">Dia 0</span>)
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="openPdfModal()" class="text-xs bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 px-2 py-1 rounded transition flex items-center gap-1 font-bold" title="Abrir PDF">
                            <i class="fa-solid fa-file-pdf"></i> Cronograma
                        </button>
                        <button onclick="configureScheduleStart()" class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 px-2 py-1 rounded transition flex items-center gap-1" title="Configurar Dia 1">
                            <i class="fa-solid fa-calendar-check"></i> Início
                        </button>
                    </div>
                </div>

                <div id="daily-mission-content" class="space-y-3 flex-1 flex flex-col justify-center">
                    <p class="text-xs text-gray-400 italic">Carregando plano...</p>
                </div>
            </div>

            <!-- Progress & Productivity Grid -->
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Progress Card -->
                <div class="glass-panel rounded-xl p-4 flex items-center justify-between">
                    <div>
                        <h3 class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wide mb-1">Progresso Geral</h3>
                        <p id="topics-count" class="text-sm text-gray-400 dark:text-gray-500">0/0 Tópicos</p>
                    </div>
                    <div class="relative h-20 w-20">
                        <canvas id="progressChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="progress-text" class="text-sm font-bold text-slate-800 dark:text-white">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Productivity Card + Cronômetro -->
                <div class="glass-panel rounded-xl p-4 flex flex-col justify-center relative">
                    <h3 class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wide mb-1 flex justify-between items-center">
                        <span>Banco de Horas</span>
                        <button onclick="resetHours()" class="text-gray-400 hover:text-red-500 transition" title="Zerar Horas"><i class="fa-solid fa-trash-can"></i></button>
                    </h3>
                    
                    <div class="flex items-end gap-2 mb-2">
                         <span id="total-hours" class="text-3xl font-bold text-slate-800 dark:text-white leading-none">0.0</span>
                         <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">hrs totais</span>
                    </div>

                    <!-- Cronômetro UI -->
                    <div class="bg-slate-100 dark:bg-slate-700/50 rounded-lg p-2 flex items-center justify-between border border-slate-200 dark:border-slate-600">
                        <span id="timer-display" class="font-mono text-lg font-bold text-slate-700 dark:text-white w-20 text-center">00:00:00</span>
                        <div class="flex gap-1">
                            <button onclick="toggleTimer()" id="btn-timer-toggle" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 text-white flex items-center justify-center transition shadow-sm"><i class="fa-solid fa-play text-xs"></i></button>
                            <button onclick="stopTimer()" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center transition shadow-sm"><i class="fa-solid fa-stop text-xs"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Desafios Card -->
                <div class="md:col-span-2 glass-panel rounded-xl p-4 flex flex-col relative overflow-hidden mt-0">
                    <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-trophy text-6xl text-yellow-500"></i></div>
                    <h3 class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-bullseye text-red-500"></i> Desafios Extras
                    </h3>
                    <div id="challenges-list" class="space-y-3 flex-1 flex flex-col justify-center">
                        <p class="text-xs text-gray-400 italic">Carregando missões...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discipline Cards -->
        <div class="glass-panel rounded-xl p-6">
            <h3 class="text-slate-700 dark:text-slate-200 text-sm font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-500"></i> Suas Disciplinas
                <span class="text-xs font-normal text-gray-400 dark:text-gray-500 ml-auto hidden sm:inline">Clique para filtrar o conteúdo</span>
            </h3>
            <div id="discipline-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <!-- Main Content: Syllabus & Reviews -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6" id="syllabus-section">
            <div class="lg:col-span-1 space-y-4">
                <button onclick="openManageModal()" class="w-full glass-panel rounded-xl p-3 text-slate-700 dark:text-slate-200 font-bold hover:bg-white dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center justify-center gap-2 text-sm shadow-sm border border-transparent hover:border-blue-200 dark:hover:border-slate-600"><i class="fa-solid fa-book-open"></i> Gerenciar Matérias</button>
                <button onclick="openSettingsModal()" class="w-full glass-panel rounded-xl p-3 text-slate-700 dark:text-slate-200 font-bold hover:bg-white dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center justify-center gap-2 text-sm shadow-sm border border-transparent hover:border-blue-200 dark:hover:border-slate-600"><i class="fa-solid fa-pen-to-square"></i> Gerenciar Dados</button>
                <button onclick="openSyncModal()" class="w-full glass-panel rounded-xl p-3 text-slate-700 dark:text-slate-200 font-bold hover:bg-white dark:hover:bg-slate-700 hover:text-green-600 dark:hover:text-green-400 transition flex items-center justify-center gap-2 text-sm shadow-sm border border-transparent hover:border-green-200 dark:hover:border-green-800"><i class="fa-solid fa-rotate"></i> Configurar Nuvem</button>
                <div class="glass-panel rounded-xl p-4 sticky top-20">
                    <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm"><i class="fa-solid fa-filter mr-2"></i>Filtros</h4>
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Disciplina Atual</label>
                        <select id="filter-discipline" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-white dark:bg-slate-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="all">Todas as Disciplinas</option></select>
                    </div>
                    <div class="space-y-2 mt-4">
                        <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Status</label>
                        <div class="flex flex-col gap-2">
                            <button onclick="filterStatus('all')" class="text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-slate-700 transition border-l-4 border-transparent bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm">Todos</button>
                            <button onclick="filterStatus('pendente')" class="text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-slate-700 transition border-l-4 border-gray-400 bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm">Pendente</button>
                            <button onclick="filterStatus('estudando')" class="text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-slate-700 transition border-l-4 border-blue-500 bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm">Em Estudo</button>
                            <button onclick="filterStatus('concluido')" class="text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-slate-700 transition border-l-4 border-green-500 bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm">Concluído</button>
                            <button onclick="filterStatus('revisar')" class="text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-slate-700 transition border-l-4 border-yellow-500 bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm font-bold text-yellow-700 dark:text-yellow-500"><i class="fa-solid fa-bell mr-1"></i> Revisar Hoje</button>
                        </div>
                    </div>
                    <div class="mt-8 pt-4 border-t dark:border-slate-700 flex flex-col gap-2">
                        <button onclick="exportData()" class="text-xs text-blue-600 dark:text-blue-400 hover:underline text-left"><i class="fa-solid fa-download"></i> Backup (Arquivo JSON)</button>
                        <label class="text-xs text-blue-600 dark:text-blue-400 hover:underline cursor-pointer text-left"><i class="fa-solid fa-upload"></i> Restaurar Backup<input type="file" id="import-file" class="hidden" onchange="importData(this)"></label>
                        <button onclick="resetData()" class="text-xs text-red-500 dark:text-red-400 hover:underline mt-2 text-left"><i class="fa-solid fa-trash"></i> Resetar Tudo (Progresso)</button>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-3">
                <div class="glass-panel rounded-xl overflow-hidden min-h-[500px]">
                    <div class="bg-gray-50 dark:bg-slate-800 px-6 py-4 border-b dark:border-slate-700 flex justify-between items-center transition-colors">
                        <h2 class="font-bold text-lg text-slate-800 dark:text-white" id="list-title">Conteúdo Programático</h2>
                        <span id="filtered-count" class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded-full">0 itens</span>
                    </div>
                    <div id="syllabus-container" class="divide-y divide-gray-100 dark:divide-slate-700"><div class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><p class="mt-2">Carregando edital...</p></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[150]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50 dark:opacity-80" onclick="closeModal('settings-modal')"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-[151] overflow-y-auto animate-fade-in-down transition-colors">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b dark:border-slate-700 mb-4"><p class="text-lg font-bold text-slate-800 dark:text-white">Gerenciar Dados</p><div class="cursor-pointer z-50 text-gray-500 dark:text-gray-400" onclick="closeModal('settings-modal')"><i class="fa-solid fa-xmark"></i></div></div>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Nome do Concurso</label><input type="text" id="config-title" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-gray-50 dark:bg-slate-700 dark:text-white"></div>
                    <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Cargo</label><input type="text" id="config-role" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-gray-50 dark:bg-slate-700 dark:text-white"></div>
                    <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Data da Prova</label><input type="date" id="config-date" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-gray-50 dark:bg-slate-700 dark:text-white"></div>
                    <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Início do Cronograma (Dia 1)</label><input type="date" id="config-start-date" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-gray-50 dark:bg-slate-700 dark:text-white"></div>
                    <div class="pt-4 border-t dark:border-slate-700"><button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold">Salvar</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[150]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50 dark:opacity-80" onclick="closeModal('sync-modal')"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-[151] overflow-y-auto animate-fade-in-down transition-colors">
            <div class="modal-content py-6 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b dark:border-slate-700 mb-4"><p class="text-lg font-bold text-slate-800 dark:text-white gap-2 flex items-center"><i class="fa-solid fa-cloud text-blue-500"></i> Sincronização (ID)</p><div class="cursor-pointer z-50 text-gray-500 dark:text-gray-400" onclick="closeModal('sync-modal')"><i class="fa-solid fa-xmark"></i></div></div>
                <div class="space-y-4">
                    <div id="sync-active-ui" class="hidden">
                        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded p-4 mb-4">
                            <p class="text-green-800 dark:text-green-400 font-bold text-sm mb-2">Conectado!</p>
                            <p class="text-xs text-green-700 dark:text-green-500">Seu ID para outros dispositivos:</p>
                            <div class="flex gap-2 mt-1"><input type="text" id="current-sync-id-display" readonly class="w-full bg-white dark:bg-slate-700 border border-green-300 dark:border-green-700 rounded p-2 text-lg font-mono font-bold text-center dark:text-white"><button onclick="copySyncId()" class="bg-green-600 text-white px-3 rounded"><i class="fa-regular fa-copy"></i></button></div>
                        </div>
                        <div class="border-t dark:border-slate-700 pt-4"><p class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Carregar outro ID:</p><div class="flex gap-2"><input type="text" id="input-sync-id" class="w-full border dark:border-slate-600 rounded p-2 text-sm font-mono uppercase bg-white dark:bg-slate-700 dark:text-white" placeholder="Cole o ID aqui..."><button onclick="loadFromSyncId()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">Carregar</button></div></div>
                    </div>
                    <div id="sync-setup-ui">
                        <p class="text-sm text-gray-500 dark:text-gray-300 mb-2">Para ativar a nuvem, cole a configuração do Firebase (JSON):</p>
                        <textarea id="firebase-config-input" class="w-full h-32 border dark:border-slate-600 rounded p-2 text-xs font-mono bg-slate-50 dark:bg-slate-700 dark:text-white" placeholder='{"apiKey": "...", "authDomain": "...", ...}'></textarea>
                        <button onclick="saveFirebaseConfig()" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold mt-2">Ativar Nuvem</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Modal (NOVO) -->
    <div id="pdf-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[200]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-90" onclick="closeModal('pdf-modal')"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-4xl h-[85vh] mx-auto rounded shadow-lg z-[201] overflow-hidden animate-fade-in-down transition-colors flex flex-col">
            <div class="flex justify-between items-center p-4 border-b dark:border-slate-700">
                <p class="text-lg font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-file-pdf text-red-500 mr-2"></i>Cronograma Completo</p>
                <div class="cursor-pointer z-50 text-gray-500 dark:text-gray-400" onclick="closeModal('pdf-modal')"><i class="fa-solid fa-xmark text-xl"></i></div>
            </div>
            <div class="flex-1 bg-gray-100 dark:bg-slate-900 relative">
                 <object data="Cronograma GM Caxias MA.pdf" type="application/pdf" width="100%" height="100%">
                    <div class="flex flex-col items-center justify-center h-full text-slate-500 p-8 text-center">
                        <p class="mb-4">Não foi possível visualizar o PDF aqui.</p>
                        <a href="Cronograma GM Caxias MA.pdf" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded">Baixar/Abrir em outra aba</a>
                        <p class="text-xs mt-4 opacity-70">Certifique-se que o arquivo "Cronograma GM Caxias MA.pdf" está na mesma pasta.</p>
                    </div>
                 </object>
            </div>
        </div>
    </div>

    <div id="note-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50 dark:opacity-80" onclick="closeModal('note-modal')"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto animate-fade-in-down transition-colors">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3"><p class="text-xl font-bold text-slate-800 dark:text-white">Anotações</p><div class="cursor-pointer z-50 text-gray-500 dark:text-gray-400" onclick="closeModal('note-modal')"><i class="fa-solid fa-xmark"></i></div></div>
                <p id="modal-topic-title" class="text-sm text-gray-500 dark:text-gray-400 mb-4">Tópico...</p>
                <textarea id="modal-note-input" class="w-full h-40 border dark:border-slate-600 rounded p-3 text-sm focus:outline-none focus:border-blue-500 bg-white dark:bg-slate-700 dark:text-white dark:placeholder-gray-400" placeholder="Escreva seus resumos, macetes ou links aqui..."></textarea>
                <div class="flex justify-end pt-4"><button onclick="saveNote()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-bold">Salvar Nota</button></div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 dark:opacity-80"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-sm mx-auto rounded-lg shadow-xl z-[70] overflow-hidden animate-fade-in-down transition-colors transform scale-100">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 dark:bg-yellow-900/30 mb-4"><i class="fa-solid fa-exclamation text-yellow-600 dark:text-yellow-400 text-xl"></i></div>
                <h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white mb-2" id="confirm-title">Confirmação</h3>
                <div class="mt-2"><p class="text-sm text-gray-500 dark:text-gray-300" id="confirm-message">Tem certeza que deseja realizar esta ação?</p></div>
            </div>
            <div class="bg-gray-50 dark:bg-slate-750 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                <button type="button" id="btn-confirm-yes" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm transition">Sim, confirmar</button>
                <button type="button" onclick="closeConfirmModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-slate-600 shadow-sm px-4 py-2 bg-white dark:bg-slate-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 dark:opacity-80"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-sm mx-auto rounded-lg shadow-xl z-[70] overflow-hidden animate-fade-in-down transition-colors transform scale-100">
            <div class="p-6">
                <h3 class="text-lg leading-6 font-bold text-slate-900 dark:text-white mb-2" id="prompt-title">Editar</h3>
                <div class="mt-2"><input type="text" id="prompt-input" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-gray-50 dark:bg-slate-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" onkeydown="if(event.key==='Enter') document.getElementById('btn-prompt-confirm').click()"></div>
            </div>
            <div class="bg-gray-50 dark:bg-slate-750 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                <button type="button" id="btn-prompt-confirm" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm transition">Salvar</button>
                <button type="button" onclick="closePromptModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-slate-600 shadow-sm px-4 py-2 bg-white dark:bg-slate-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50 dark:opacity-80" onclick="closeModal('manage-modal')"></div>
        <div class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto animate-fade-in-down max-h-[90vh] transition-colors">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b dark:border-slate-700 mb-4"><p class="text-lg font-bold text-slate-800 dark:text-white">Gerenciar Matérias</p><div class="cursor-pointer z-50 text-gray-500 dark:text-gray-400" onclick="closeModal('manage-modal')"><i class="fa-solid fa-xmark"></i></div></div>
                <div class="flex gap-4 border-b dark:border-slate-700 mb-4 overflow-x-auto">
                    <button onclick="switchTab('tab-add-topic')" id="btn-tab-add-topic" class="pb-2 text-sm tab-active whitespace-nowrap">Novos Tópicos</button>
                    <button onclick="switchTab('tab-add-lesson')" id="btn-tab-add-lesson" class="pb-2 text-sm tab-inactive whitespace-nowrap">Nova Aula</button>
                    <button onclick="switchTab('tab-add-disc')" id="btn-tab-add-disc" class="pb-2 text-sm tab-inactive whitespace-nowrap">Nova Disciplina</button>
                    <button onclick="switchTab('tab-del-disc')" id="btn-tab-del-disc" class="pb-2 text-sm tab-inactive whitespace-nowrap">Excluir Disciplinas</button>
                    <button onclick="switchTab('tab-del-lesson')" id="btn-tab-del-lesson" class="pb-2 text-sm tab-inactive whitespace-nowrap">Excluir Aulas</button>
                    <button onclick="switchTab('tab-del-topic')" id="btn-tab-del-topic" class="pb-2 text-sm tab-inactive whitespace-nowrap text-red-500">Excluir Tópicos</button>
                </div>
                <div id="tab-add-topic" class="block">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Disciplina</label><select id="new-topic-disc-select" onchange="populateLessonSelect(this.value, 'new-topic-lesson-select')" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-white dark:bg-slate-700 dark:text-white"></select></div>
                            <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Aula</label><select id="new-topic-lesson-select" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-white dark:bg-slate-700 dark:text-white"></select></div>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Lista de Tópicos</label><p class="text-[10px] text-gray-400 dark:text-gray-500 mb-1">Cole a lista abaixo, um item por linha.</p><textarea id="new-topic-name" class="w-full border dark:border-slate-600 rounded p-2 text-sm h-24 bg-white dark:bg-slate-700 dark:text-white" placeholder="Ex:&#10;Crase&#10;Regência Nominal..."></textarea></div>
                        <button onclick="addNewTopic()" class="w-full bg-green-600 text-white py-2 rounded text-sm font-bold hover:bg-green-700">Adicionar Tópicos</button>
                    </div>
                </div>
                <div id="tab-add-lesson" class="hidden">
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Selecione a Disciplina</label><select id="new-lesson-disc-select" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-white dark:bg-slate-700 dark:text-white"></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Lista de Aulas</label><p class="text-[10px] text-gray-400 dark:text-gray-500 mb-1">Cole a lista abaixo, uma aula por linha.</p><textarea id="new-lesson-name" class="w-full border dark:border-slate-600 rounded p-2 text-sm h-24 bg-white dark:bg-slate-700 dark:text-white" placeholder="Ex:&#10;Aula 02 - Fonologia&#10;Aula 03 - Morfologia..."></textarea></div>
                        <button onclick="addNewLesson()" class="w-full bg-blue-500 text-white py-2 rounded text-sm font-bold hover:bg-blue-600">Adicionar Aulas</button>
                    </div>
                </div>
                <div id="tab-add-disc" class="hidden"><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Lista de Novas Disciplinas</label><textarea id="new-disc-name" class="w-full border dark:border-slate-600 rounded p-2 text-sm h-32 bg-white dark:bg-slate-700 dark:text-white" placeholder="Ex:&#10;Legislação Extravagante&#10;Redação..."></textarea></div><button onclick="addNewDiscipline()" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold hover:bg-blue-700">Criar Disciplinas</button></div></div>
                <div id="tab-del-disc" class="hidden"><p class="text-xs text-red-500 dark:text-red-400 mb-4 bg-red-50 dark:bg-red-900/30 p-2 rounded"><i class="fa-solid fa-triangle-exclamation"></i> Apaga a disciplina e TODAS as suas aulas/tópicos.</p><div id="delete-disc-list" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div></div>
                <div id="tab-del-lesson" class="hidden"><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Filtrar por Disciplina</label><select id="del-lesson-disc-select" onchange="renderDeleteLessonList()" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-white dark:bg-slate-700 dark:text-white"></select></div><div id="delete-lesson-list" class="space-y-2 max-h-60 overflow-y-auto pr-1 border dark:border-slate-600 rounded p-2"></div></div></div>
                <div id="tab-del-topic" class="hidden"><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Filtrar por Disciplina</label><select id="del-topic-disc-select" onchange="renderBulkDeleteTopicList()" class="w-full border dark:border-slate-600 rounded p-2 text-sm bg-white dark:bg-slate-700 dark:text-white"></select></div><div><div class="flex justify-between items-end mb-2"><label class="block text-xs font-bold text-gray-500 dark:text-gray-400">Selecione os tópicos</label><button onclick="toggleSelectAllDelete()" id="btn-select-all-del" class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 font-bold bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded"><i class="fa-regular fa-square-check mr-1"></i> Selecionar Todos</button></div><div id="bulk-delete-list" class="space-y-0 max-h-60 overflow-y-auto pr-2 border dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-gray-200"></div></div><button onclick="deleteSelectedTopics()" class="w-full bg-red-600 text-white py-2 rounded text-sm font-bold hover:bg-red-700 shadow-sm"><i class="fa-solid fa-trash mr-1"></i> Excluir Selecionados</button></div></div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[200] flex flex-col gap-2"></div>

    <script>
        // --- FUNCTIONS DECLARATIONS (Hoisted) ---
        function generateId() { return Array.from(crypto.getRandomValues(new Uint8Array(4))).map(b=>b.toString(16).padStart(2,'0')).join(''); }
        function initTheme() { const saved = localStorage.getItem('theme'); if(saved==='dark'||(!saved&&window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); updateThemeIcon(); }
        function updateThemeIcon() { const i=document.getElementById('theme-icon'); if(document.documentElement.classList.contains('dark')){i.classList.remove('fa-sun');i.classList.add('fa-moon');}else{i.classList.remove('fa-moon');i.classList.add('fa-sun');} }
        function toggleTheme() { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateThemeIcon(); }

        // --- GLOBAL CONSTANTS ---
        const defaultDisciplines = [{id:'port',name:'Língua Portuguesa'},{id:'rlm',name:'Raciocínio Lógico-Matemático'},{id:'info',name:'Informática'},{id:'regional',name:'Conhecimentos Regionais (PI)'},{id:'penal',name:'Direito Penal'},{id:'procpenal',name:'Direito Processual Penal'},{id:'const',name:'Direito Constitucional'},{id:'adm',name:'Direito Administrativo'},{id:'leginst',name:'Legislação Institucional'},{id:'dh',name:'Direitos Humanos'},{id:'crim',name:'Criminologia'},{id:'medlegal',name:'Medicina Legal'}];
        const rawTopics = [{d:'port',t:'Interpretação de texto'},{d:'port',t:'Gramática'},{d:'rlm',t:'Lógica Proposicional'},{d:'rlm',t:'Conjuntos'},{d:'info',t:'Hardware'},{d:'info',t:'Software'},{d:'regional',t:'História do Piauí'},{d:'regional',t:'Geografia do Piauí'},{d:'penal',t:'Aplicação da Lei Penal'},{d:'penal',t:'Crimes'},{d:'procpenal',t:'Inquérito'},{d:'procpenal',t:'Prisões'},{d:'const',t:'Direitos Fundamentais'},{d:'const',t:'Organização do Estado'},{d:'adm',t:'Atos Administrativos'},{d:'adm',t:'Poderes'},{d:'leginst',t:'Estatuto PC-PI'},{d:'dh',t:'Declaração Universal'},{d:'crim',t:'Escolas Criminológicas'},{d:'medlegal',t:'Traumatologia'}];
        const studySchedule = [
            { day: 1, tasks: ["Direitos Humanos: Itens 1 a 5", "Leg. Trânsito: Itens 1 a 4"] },
            { day: 2, tasks: ["Língua Portuguesa: Itens 1 a 5", "RLM: Itens 1 a 4"] },
            { day: 3, tasks: ["Dir. Constitucional: Itens 1 a 5", "Direitos Humanos: Itens 6 a 10"] },
            { day: 4, tasks: ["Leg. Trânsito: Itens 5 a 9", "Informática: Itens 1 a 4"] },
            { day: 5, tasks: ["Dir. Administrativo: Itens 1 a 5", "Dir. Ambiental: Itens 1 a 4"] },
            { day: 6, tasks: ["Redação: Teoria básica + 1 texto treino", "Direitos Humanos: Itens 11 a 15"] },
            { day: 7, tasks: ["Língua Portuguesa: Itens 6 a 10", "RLM: Itens 5 a 9"] },
            { day: 8, tasks: ["Dir. Constitucional: Itens 6 a 10", "Leg. Trânsito: Itens 10 a 14"] },
            { day: 9, tasks: ["Direitos Humanos: Itens 16 a 20", "Dir. Penal: Itens 1 a 4"] },
            { day: 10, tasks: ["Informática: Itens 5 a 9", "Dir. Administrativo: Itens 6 a 10"] },
            { day: 11, tasks: ["Língua Portuguesa: Itens 11 a 15", "RLM: Itens 10 a 14"] },
            { day: 12, tasks: ["Direitos Humanos: Itens 21 a 25", "Dir. Ambiental: Itens 5 a 8"] },
            { day: 13, tasks: ["Redação: 1 Redação (Tema: Trânsito)", "Leg. Trânsito: Itens 15 a 19"] },
            { day: 14, tasks: ["Dir. Constitucional: Itens 11 a 15", "Dir. Penal: Itens 5 a 8"] },
            { day: 15, tasks: ["Direitos Humanos: Itens 26 a 30", "Informática: Itens 10 a 14"] },
            { day: 16, tasks: ["Língua Portuguesa: Itens 16 a 20", "RLM: Itens 15 a 19"] },
            { day: 17, tasks: ["Leg. Trânsito: Itens 20 a 24", "Dir. Administrativo: Itens 11 a 15"] },
            { day: 18, tasks: ["Direitos Humanos: Itens 31 a 35", "Dir. Ambiental: Itens 9 a 12"] },
            { day: 19, tasks: ["Dir. Constitucional: Itens 16 a 20", "Estatuto Geral Guardas: Itens 1 a 3"] },
            { day: 20, tasks: ["Redação: 1 Redação Treino", "Dir. Penal: Itens 9 a 13"] },
            { day: 21, tasks: ["Leg. Trânsito: Itens 25 a 29", "Informática: Itens 15 a 19"] },
            { day: 22, tasks: ["Língua Portuguesa: Itens 21 a 25", "RLM: Itens 20 a 24"] },
            { day: 23, tasks: ["Direitos Humanos: Itens 36 a 40", "Dir. Administrativo: Itens 16 a 20"] },
            { day: 24, tasks: ["Feriado/Descanso ou Leitura leve"] },
            { day: 25, tasks: ["Dir. Penal: Itens 14 a 18", "Estatuto Geral Guardas: Itens 4 a 5 (FIM)"] },
            { day: 26, tasks: ["Leg. Trânsito: Itens 30 a 34", "Dir. Ambiental: Itens 13 a 16"] },
            { day: 27, tasks: ["Redação: 1 Redação Treino", "Dir. Constitucional: Itens 21 a 25"] },
            { day: 28, tasks: ["Direitos Humanos: Itens 41 a 45", "Informática: Itens 20 a 24"] },
            { day: 29, tasks: ["Língua Portuguesa: Itens 26 a 30", "RLM: Itens 25 a 29"] },
            { day: 30, tasks: ["Dir. Penal: Itens 19 a 22", "Leg. Mun. Caxias: Itens 1 a 3 (FIM)"] },
            { day: 31, tasks: ["Feriado/Descanso"] },
            { day: 32, tasks: ["Dir. Penal: Itens 23 a 26 (FIM)", "Leg. Trânsito: Itens 35 a 39"] },
            { day: 33, tasks: ["Dir. Administrativo: Itens 21 a 25", "Dir. Ambiental: Itens 17 a 20"] },
            { day: 34, tasks: ["Redação: 1 Redação Treino", "Dir. Constitucional: Itens 26 a 30"] },
            { day: 35, tasks: ["Direitos Humanos: Itens 46 a 55", "Informática: Itens 25 a 29"] },
            { day: 36, tasks: ["Língua Portuguesa: Itens 31 a 38", "RLM: Itens 30 a 37"] },
            { day: 37, tasks: ["Leg. Trânsito: Itens 40 a 48", "Dir. Administrativo: Itens 26 a 30"] },
            { day: 38, tasks: ["Direitos Humanos: Itens 56 a 65", "Dir. Ambiental: Itens 21 a 24"] },
            { day: 39, tasks: ["Dir. Constitucional: Itens 31 a 38", "Informática: Itens 30 a 34"] },
            { day: 40, tasks: ["Língua Portuguesa: Itens 39 a 46", "RLM: Itens 38 a 45"] },
            { day: 41, tasks: ["Redação: 1 Redação Treino", "Leg. Trânsito: Itens 49 a 57"] },
            { day: 42, tasks: ["Dir. Administrativo: Itens 31 a 38", "Dir. Ambiental: Itens 25 a 28"] },
            { day: 43, tasks: ["Direitos Humanos: Itens 66 a 75", "Informática: Itens 35 a 40"] },
            { day: 44, tasks: ["Língua Portuguesa: Itens 47 a 54", "RLM: Itens 46 a 53"] },
            { day: 45, tasks: ["Dir. Constitucional: Itens 39 a 48", "Dir. Ambiental: Itens 29 a 36 (FIM)"] },
            { day: 46, tasks: ["Leg. Trânsito: Itens 58 a 66", "Dir. Administrativo: Itens 39 a 47 (FIM)"] },
            { day: 47, tasks: ["Informática: Itens 41 a 48 (FIM)", "Direitos Humanos: Itens 76 a 85"] },
            { day: 48, tasks: ["Redação: 1 Redação Treino", "Conhec. Locais: Item 1 (FIM)"] },
            { day: 49, tasks: ["Língua Portuguesa: Itens 55 a 63 (FIM)", "RLM: Itens 54 a 60"] },
            { day: 50, tasks: ["Leg. Trânsito: Itens 67 a 76 (FIM)", "Dir. Constitucional: Itens 49 a 57"] },
            { day: 51, tasks: ["Direitos Humanos: Itens 86 a 94 (FIM)", "RLM: Itens 61 a 67 (FIM)"] },
            { day: 52, tasks: ["Dir. Constitucional: Itens 58 a 66 (FIM)", "EDITAL ZERADO!"] },
            { day: 53, tasks: ["Revisão de Tampão / Atrasos"] },
            { day: 54, tasks: ["Revisão de Tampão / Atrasos"] },
            { day: 55, tasks: ["Revisão de Tampão / Atrasos"] },
            { day: 56, tasks: ["Revisão de Tampão / Atrasos"] },
            { day: 57, tasks: ["Simulado Geral 01 (Prova completa)"] },
            { day: 58, tasks: ["Correção do Simulado e Identificação de Falhas"] },
            { day: 59, tasks: ["Reforço Teórico: Pontos fracos"] },
            { day: 60, tasks: ["Organização de material de revisão (Fev)"] },
            { day: 61, tasks: ["Revisão Rápida: Estatutos e Leg. Municipal"] },
            { day: 62, tasks: ["Redação Final", "FIM DA FASE TEÓRICA!"] }
        ];

        // --- GLOBAL STATE VARIABLES (Defined BEFORE usage) ---
        let app = null, db = null, auth = null;
        let useFirebase = false;
        let currentSyncId = localStorage.getItem('pcpi_sync_id') || generateId();
        let unsubscribeSnapshot = null;
        let expandedDisciplines = new Set(), expandedSections = new Set();
        let currentFilterDiscipline = 'all', currentFilterStatus = 'all';
        let currentEditingId = null;
        let chartInstances = {};
        let userFirebaseConfig = localStorage.getItem('pcpi_firebase_config');
        let timerInterval = null;
        let isTimerRunning = false;
        let timerSeconds = 0;

        // --- CORE APP STATE ---
        let appState = { 
            items: [], disciplines: [], lessons: [], totalHours: 0, 
            config: { title: 'PC-PI 2026', role: 'Oficial Investigador', examDate: '2026-01-25' },
            gamification: { streak: 0, lastStudyDate: null, challenges: [] }
        };

        // --- CORE FUNCTIONS ---
        function initDefaultState() {
            appState.disciplines = JSON.parse(JSON.stringify(defaultDisciplines));
            appState.lessons = [];
            appState.disciplines.forEach(d => { appState.lessons.push({ id: `l_${d.id}_01`, disciplineId: d.id, name: 'Aula 01' }); });
            appState.items = rawTopics.map((item, index) => ({ id: Date.now() + index, disciplineId: item.d, lessonId: `l_${item.d}_01`, topic: item.t, status: 'pendente', completedDate: null, reviews: [], note: '' }));
            appState.gamification = { streak: 0, lastStudyDate: null, challenges: generateDailyChallenges() };
        }

        function migrateStructure() {
            if (!appState.lessons) appState.lessons = [];
            if (appState.disciplines && appState.lessons.length === 0) appState.disciplines.forEach(d => { appState.lessons.push({ id: `l_${d.id}_default`, disciplineId: d.id, name: 'Aula 01' }); });
            if (appState.items) appState.items.forEach(item => { if (!item.lessonId) { let lesson = appState.lessons.find(l => l.disciplineId === item.disciplineId); if (!lesson) { lesson = { id: `l_${item.disciplineId}_migrated`, disciplineId: item.disciplineId, name: 'Aula 01' }; appState.lessons.push(lesson); } item.lessonId = lesson.id; } });
            if(!appState.config) appState.config = { title: 'PC-PI 2026', role: 'Oficial Investigador', examDate: '2026-01-25' };
            if(!appState.gamification) appState.gamification = { streak: 0, lastStudyDate: null, challenges: generateDailyChallenges() };
        }

        async function saveDataInternal() {
            localStorage.setItem('pcpi_planner_v1', JSON.stringify(appState));
            if(useFirebase && db && currentSyncId) {
                try { await db.collection('planners').doc(currentSyncId).set({ json: JSON.stringify(appState), lastUpdated: new Date().toISOString() }); } 
                catch(e){ console.error("Cloud save failed", e); }
            }
        }

        function generateDailyChallenges() {
            const types = [{ id: 'study_1h', text: 'Estudar 1 hora líquida', target: 1, type: 'hours', current: 0 }, { id: 'study_3_items', text: 'Concluir 3 tópicos', target: 3, type: 'items', current: 0 }, { id: 'review_1', text: 'Fazer 1 revisão', target: 1, type: 'review', current: 0 }, { id: 'study_2h', text: 'Estudar 2 horas líquidas', target: 2, type: 'hours', current: 0 }];
            return types.sort(() => 0.5 - Math.random()).slice(0, 3).map(c => ({...c, done: false}));
        }

        function loadDataOffline() {
            const stored = localStorage.getItem('pcpi_planner_v1');
            if(stored) { try { appState = { ...appState, ...JSON.parse(stored) }; migrateStructure(); } catch(e) { console.error(e); } } else { initDefaultState(); }
            renderAll(); renderHeader();
        }

        function setupRealtimeListener(id) {
            if(!db) return;
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            unsubscribeSnapshot = db.collection('planners').doc(id).onSnapshot((snap) => {
                document.getElementById('loading-overlay').classList.add('hidden-force');
                updateStatusIndicator(true);
                if(snap.exists) {
                    const data = snap.data();
                    if(data && data.json) { try { appState = JSON.parse(data.json); migrateStructure(); renderAll(); renderHeader(); initCountdown(); } catch(e) { console.error("Parse reset", e); } }
                }
            }, (error) => { console.error("Sync error:", error); updateStatusIndicator(false); });
        }

        function initApp() {
            loadDataOffline();
            if (userFirebaseConfig) {
                try {
                    const config = JSON.parse(userFirebaseConfig);
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    auth = firebase.auth(); db = firebase.firestore(); useFirebase = true;
                    auth.signInAnonymously().then(() => { setupRealtimeListener(currentSyncId); updateSyncUI(true); }).catch(e => console.error("Auth Anon Error", e));
                } catch (e) { console.error("Firebase Init Error:", e); updateSyncUI(false); }
            } else { updateSyncUI(false); }
            initCountdown();
        }

        // --- TIMER FUNCTIONS ---
        function formatTime(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        window.toggleTimer = () => {
            const btn = document.getElementById('btn-timer-toggle');
            if(isTimerRunning) {
                // Pause
                clearInterval(timerInterval);
                isTimerRunning = false;
                btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
                btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                // Start
                isTimerRunning = true;
                btn.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    document.getElementById('timer-display').innerText = formatTime(timerSeconds);
                }, 1000);
            }
        };

        window.stopTimer = () => {
            if(timerSeconds === 0) return;
            if(confirm(`Parar e salvar ${formatTime(timerSeconds)}?`)) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('btn-timer-toggle').innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
                document.getElementById('btn-timer-toggle').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                document.getElementById('btn-timer-toggle').classList.add('bg-green-500', 'hover:bg-green-600');
                
                // Add hours
                const hoursToAdd = parseFloat((timerSeconds / 3600).toFixed(2));
                addStudyHoursInternal(hoursToAdd);
                
                // Reset
                timerSeconds = 0;
                document.getElementById('timer-display').innerText = "00:00:00";
            }
        };

        // --- EVENT LISTENERS ---
        window.addEventListener('load', () => { initTheme(); initApp(); setTimeout(() => { const overlay = document.getElementById('loading-overlay'); if(overlay && !overlay.classList.contains('hidden-force')) overlay.classList.add('hidden-force'); }, 2000); });

        // --- RENDERERS & UI LOGIC ---
        function renderAll() { initGamification(); renderSyllabus(); renderCharts(); renderDisciplineCards(); renderProductivity(); }
        
        function initGamification() {
            if (!appState.gamification) appState.gamification = { streak: 0, lastStudyDate: null, challenges: [] };
            if (!appState.config.startDate) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                appState.config.startDate = tomorrow.toISOString().split('T')[0];
            }
            const today = new Date().toISOString().split('T')[0];
            const lastDate = appState.gamification.lastStudyDate;

            if (!lastDate || lastDate !== today) {
                if (appState.gamification.challenges.length === 0 || lastDate !== today) appState.gamification.challenges = generateDailyChallenges();
                if (lastDate) {
                    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                    const yStr = yesterday.toISOString().split('T')[0];
                    if (lastDate !== yStr && lastDate !== today) appState.gamification.streak = 0;
                }
            }
            renderGamification();
        }

        function renderGamification() {
            const streakIcon = document.getElementById('streak-icon');
            const streakCount = document.getElementById('streak-count');
            if(appState.gamification) {
                streakCount.innerText = appState.gamification.streak;
                if(appState.gamification.streak > 0) { streakIcon.classList.remove('flame-inactive'); streakIcon.classList.add('flame-active'); } 
                else { streakIcon.classList.add('flame-inactive'); streakIcon.classList.remove('flame-active'); }
                
                const list = document.getElementById('challenges-list');
                list.innerHTML = '';
                if(appState.gamification.challenges && appState.gamification.challenges.length > 0) {
                    appState.gamification.challenges.forEach(c => {
                        const div = document.createElement('div');
                        div.className = `flex items-center justify-between p-2 rounded border ${c.done ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' : 'bg-gray-50 border-gray-100 dark:bg-slate-800 dark:border-slate-700'}`;
                        div.innerHTML = `<div class="flex items-center gap-2"><i class="${c.done ? 'fa-solid fa-check-circle text-green-500' : 'fa-regular fa-circle text-gray-400'}"></i><span class="text-xs ${c.done ? 'text-green-700 dark:text-green-400 line-through' : 'text-gray-600 dark:text-gray-300'}">${c.text}</span></div><span class="text-[10px] font-bold text-gray-400">${Math.min(c.current, c.target)}/${c.target}</span>`;
                        list.appendChild(div);
                    });
                } else { list.innerHTML = '<p class="text-xs text-center text-gray-400">Tudo concluído por hoje!</p>'; }

                const missionContent = document.getElementById('daily-mission-content');
                const missionDayDisplay = document.getElementById('mission-day-display');
                
                if (appState.config.startDate) {
                    const startParts = appState.config.startDate.split('-');
                    const start = new Date(startParts[0], startParts[1] - 1, startParts[2]); 
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const diffTime = today - start;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                    
                    missionDayDisplay.innerText = `Dia ${diffDays > 0 ? diffDays : 'Pré'}`;
                    
                    if (diffDays > 0) {
                        const todaySchedule = studySchedule.find(s => s.day === diffDays);
                        if (todaySchedule) {
                             missionContent.innerHTML = '';
                             todaySchedule.tasks.forEach(task => {
                                 const p = document.createElement('p');
                                 p.className = "text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-purple-500 pl-2 py-1 bg-purple-50 dark:bg-slate-800 rounded-r mb-1";
                                 p.innerText = task;
                                 missionContent.appendChild(p);
                             });
                             if (!sessionStorage.getItem('mission_notified_' + diffDays)) {
                                 showToast('Nova missão disponível!', 'success');
                                 sessionStorage.setItem('mission_notified_' + diffDays, 'true');
                             }
                        } else { missionContent.innerHTML = '<p class="text-xs text-gray-400 italic">Dia livre ou revisão! (Ou dia não cadastrado)</p>'; }
                    } else { missionContent.innerHTML = '<p class="text-xs text-gray-400 italic">O cronograma começa em breve!</p>'; }
                }
            }
        }

        function checkChallengeProgress(type, amount = 1) {
            if(!appState.gamification || !appState.gamification.challenges) return;
            let changed = false;
            const today = new Date().toISOString().split('T')[0];
            if (appState.gamification.lastStudyDate !== today) {
                appState.gamification.lastStudyDate = today;
                appState.gamification.streak += 1;
                showToast(`Ofensiva aumentada! ${appState.gamification.streak} dias! 🔥`, 'success');
                changed = true;
            }
            appState.gamification.challenges.forEach(c => {
                if (!c.done && c.type === type) {
                    c.current += amount;
                    if (c.current >= c.target) { c.done = true; showToast(`Desafio Concluído: ${c.text}! 🏆`, 'success'); }
                    changed = true;
                }
            });
            if (changed) { saveDataInternal(); renderGamification(); }
        }

        function renderSyllabus() {
            const container = document.getElementById('syllabus-container');
            container.innerHTML = '';
            const today = new Date().setHours(0,0,0,0);
            const activeItems = appState.items.filter(i => {
                if(currentFilterDiscipline !== 'all' && i.disciplineId !== currentFilterDiscipline) return false;
                if(currentFilterStatus === 'all') return true;
                if(currentFilterStatus === 'revisar') return i.reviews.some(r => new Date(r.date).setHours(0,0,0,0) <= today && !r.done);
                return i.status === currentFilterStatus;
            });
            document.getElementById('filtered-count').innerText = `${activeItems.length} itens`;
            if (activeItems.length === 0) { container.innerHTML = '<div class="p-8 text-center text-gray-400">Nada encontrado.</div>'; return; }
            const visibleDiscs = appState.disciplines.filter(d => currentFilterDiscipline === 'all' || currentFilterDiscipline === d.id);
            visibleDiscs.forEach(disc => {
                const discItems = activeItems.filter(i => i.disciplineId === disc.id);
                if (discItems.length === 0) return;
                const isDiscExpanded = expandedSections.has(disc.id) || currentFilterDiscipline === disc.id;
                const discDiv = document.createElement('div');
                discDiv.className = 'border-b border-gray-200 dark:border-slate-700';
                const discHeader = document.createElement('button');
                discHeader.onclick = () => window.toggleSection(disc.id);
                discHeader.className = 'w-full bg-blue-50 dark:bg-slate-700 hover:bg-blue-100 dark:hover:bg-slate-600 px-6 py-4 flex justify-between items-center text-left focus:outline-none transition border-l-4 border-blue-500 dark:border-blue-400 shadow-sm z-10 relative';
                discHeader.innerHTML = `<span class="text-sm font-bold text-slate-800 dark:text-white uppercase tracking-wide flex items-center gap-2"><i class="fa-solid fa-book text-blue-500/50"></i>${disc.name}<span class="text-xs bg-blue-200 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-0.5 rounded-full ml-2 font-bold normal-case">${discItems.length}</span></span><i class="fa-solid fa-chevron-down text-slate-400 dark:text-slate-300 text-xs accordion-icon ${isDiscExpanded ? 'rotate' : ''}"></i>`;
                discDiv.appendChild(discHeader);
                const discContent = document.createElement('div');
                discContent.className = `accordion-content ${isDiscExpanded ? 'open' : ''}`;
                const discLessons = appState.lessons.filter(l => l.disciplineId === disc.id);
                const itemsNoLesson = discItems.filter(i => !i.lessonId);
                discLessons.forEach(lesson => {
                    const lessonItems = discItems.filter(i => i.lessonId === lesson.id);
                    if (lessonItems.length === 0) return;
                    const lessonKey = `lesson_${lesson.id}`;
                    const isLessonExpanded = expandedSections.has(lessonKey);
                    const lessonHeader = document.createElement('div');
                    lessonHeader.onclick = () => window.toggleSection(lessonKey);
                    lessonHeader.className = 'w-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-750 px-6 py-2 flex justify-between items-center text-left cursor-pointer transition border-l-4 border-gray-300 dark:border-slate-600 ml-0 group';
                    lessonHeader.innerHTML = `<div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider pl-4">${lesson.name}</span><button onclick="editLessonName('${lesson.id}', event)" class="hidden md:block text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition p-1 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 opacity-0 group-hover:opacity-100" title="Renomear Aula"><i class="fa-solid fa-pen text-[10px]"></i></button></div><i class="fa-solid fa-chevron-down text-gray-400 text-xs accordion-icon ${isLessonExpanded ? 'rotate' : ''}"></i>`;
                    discContent.appendChild(lessonHeader);
                    const lessonContent = document.createElement('div');
                    lessonContent.className = `accordion-content ${isLessonExpanded ? 'open' : ''}`;
                    lessonItems.forEach(item => { lessonContent.appendChild(createItemElement(item, today)); });
                    discContent.appendChild(lessonContent);
                });
                if(itemsNoLesson.length > 0) itemsNoLesson.forEach(item => { discContent.appendChild(createItemElement(item, today)); });
                discDiv.appendChild(discContent);
                container.appendChild(discDiv);
            });
        }

        function createItemElement(item, today) {
            const el = document.createElement('div');
            let statusClass = 'status-pendente';
            if (item.status === 'estudando') statusClass = 'status-estudo';
            if (item.status === 'concluido') statusClass = 'status-concluido';
            el.className = `p-4 pl-8 hover:bg-gray-50 dark:hover:bg-slate-700/30 transition flex flex-col sm:flex-row sm:items-center justify-between gap-4 border-t border-gray-100 dark:border-slate-700/50 bg-white dark:bg-slate-800 ${statusClass}`;
            let reviewsHtml = '';
            if (item.status === 'concluido') {
                reviewsHtml = `<div class="flex gap-2 mt-2 sm:mt-0">`;
                item.reviews.forEach((r, idx) => {
                    const rDate = new Date(r.date);
                    const isDue = rDate.setHours(0,0,0,0) <= today;
                    const dateStr = new Date(r.date).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                    let colorClass = r.done ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-300 dark:border-green-800' : (isDue ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 border border-yellow-400 dark:border-yellow-700 animate-pulse font-bold' : 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-800');
                    reviewsHtml += `<div class="flex flex-col items-center cursor-pointer" onclick="toggleReview(${item.id}, ${idx})" title="${dateStr}"><span class="text-[10px] uppercase font-bold text-gray-500 dark:text-gray-400">${r.label}</span><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs ${colorClass}">${r.done ? '<i class="fa-solid fa-check"></i>' : dateStr}</div></div>`;
                });
                reviewsHtml += `</div>`;
            }
            el.innerHTML = `<div class="flex-1 pl-4"><div class="flex items-start justify-between"><span class="text-sm font-medium text-slate-700 dark:text-gray-200">${item.topic}</span><div class="flex items-center gap-2 ml-2"><button onclick="openNoteModal(${item.id})" class="text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400"><i class="fa-regular fa-pen-to-square"></i> ${item.note ? '<i class="fa-solid fa-circle text-[8px] text-blue-500 dark:text-blue-400 align-top"></i>' : ''}</button><button onclick="deleteTopic(${item.id})" class="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button></div></div><div class="mt-2"><select onchange="updateStatus(${item.id}, this.value)" class="text-xs border dark:border-slate-600 rounded p-1 bg-white dark:bg-slate-700 focus:ring-1 focus:ring-blue-500 ${item.status === 'estudando' ? 'text-blue-600 dark:text-blue-400 font-bold' : (item.status === 'concluido' ? 'text-green-600 dark:text-green-400 font-bold' : 'text-gray-600 dark:text-gray-400')}"><option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option><option value="estudando" ${item.status === 'estudando' ? 'selected' : ''}>Em Estudo</option><option value="concluido" ${item.status === 'concluido' ? 'selected' : ''}>Concluído</option></select></div></div>${reviewsHtml}`;
            return el;
        }

        function renderCharts() {
            const total = appState.items.length;
            const completed = appState.items.filter(i => i.status === 'concluido').length;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('progress-text').innerText = `${percent}%`;
            document.getElementById('topics-count').innerText = `${completed}/${total} Tópicos`;
            const ctx = document.getElementById('progressChart').getContext('2d');
            if(chartInstances.progress) chartInstances.progress.destroy();
            chartInstances.progress = new Chart(ctx, { type: 'doughnut', data: { labels: ['Concluído', 'Restante'], datasets: [{ data: [completed, total-completed], backgroundColor: ['#10b981', '#e2e8f0'], borderWidth: 0, cutout: '75%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
        }

        function renderDisciplineCards() {
            const c = document.getElementById('discipline-cards-container'); c.innerHTML = '';
            appState.disciplines.forEach(d => {
                const items = appState.items.filter(i => i.disciplineId === d.id);
                const total = items.length;
                const comp = items.filter(i => i.status === 'concluido').length;
                const pct = total === 0 ? 0 : Math.round((comp / total) * 100);
                const el = document.createElement('div');
                el.className = "bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg p-4 shadow-sm transition cursor-pointer relative overflow-hidden group disc-card";
                el.onclick = () => window.filterByDisciplineFromCard(d.id);
                el.innerHTML = `<div class="flex justify-between items-end mb-2"><h4 class="font-bold text-slate-700 dark:text-gray-200 text-sm truncate pr-2 flex-1">${d.name}</h4><span class="text-xs font-bold ${pct===100?'text-green-600':'text-blue-600'}">${pct}%</span></div><div class="w-full bg-gray-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden"><div class="bg-blue-500 h-2 rounded-full" style="width: ${pct}%"></div></div><div class="flex justify-between items-center mt-3"><span class="text-[10px] text-gray-400 uppercase">Progresso</span><span class="text-[10px] text-gray-500 font-bold">${comp}/${total}</span></div>`;
                c.appendChild(el);
            });
        }

        function renderProductivity() { document.getElementById('total-hours').innerText = appState.totalHours.toFixed(1); }
        function renderHeader() { if(!appState.config) return; document.getElementById('header-title').innerText = appState.config.title; document.getElementById('header-subtitle').innerText = appState.config.role; const d = appState.config.examDate.split('-'); const fmt = `${d[2]}/${d[1]}/${d[0]}`; document.getElementById('header-date').innerText = fmt; document.getElementById('header-date-mobile').innerText = fmt; }
        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const e = document.createElement('div'); const cl = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-slate-800 dark:bg-slate-700'); e.className = `${cl} text-white text-sm px-4 py-3 rounded shadow-lg transition transform translate-y-2 opacity-0 flex items-center gap-2`; e.innerHTML = `<i class="fa-solid fa-circle-info"></i> ${msg}`; c.appendChild(e); requestAnimationFrame(() => e.classList.remove('translate-y-2', 'opacity-0')); setTimeout(() => { e.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => e.remove(), 300); }, 3000); }
        function initCountdown() { const d = (appState.config?appState.config.examDate:'2026-01-25')+'T00:00:00'; const t = new Date(d); const u = () => { const n = new Date(); const diff = t - n; const days = Math.ceil(diff / (1000*60*60*24)); const txt = days > 0 ? `${days} dias` : 'Hoje!'; document.getElementById('countdown-mobile').innerText = txt; document.getElementById('countdown-desktop').innerText = txt; }; u(); }
        
        // --- EXPLICIT WINDOW ATTACHMENTS ---
        window.populateModalSelects = function() { const d1 = document.getElementById('new-topic-disc-select'); const d2 = document.getElementById('new-lesson-disc-select'); const d3 = document.getElementById('del-lesson-disc-select'); const d4 = document.getElementById('del-topic-disc-select'); [d1, d2, d3, d4].forEach(s => { s.innerHTML = ''; appState.disciplines.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.innerText = d.name; s.appendChild(o); }) }); if(appState.disciplines.length > 0) populateLessonSelect(appState.disciplines[0].id, 'new-topic-lesson-select'); const fm = document.getElementById('filter-discipline'); fm.innerHTML = '<option value="all">Todas as Disciplinas</option>'; appState.disciplines.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.innerText = d.name; fm.appendChild(o); }); fm.value = currentFilterDiscipline; fm.onchange = (e) => { currentFilterDiscipline = e.target.value; renderSyllabus(); }; };
        window.populateLessonSelect = function(discId, targetId) { const sel = document.getElementById(targetId); sel.innerHTML = ''; const lessons = appState.lessons.filter(l => l.disciplineId === discId); lessons.forEach(l => { const o = document.createElement('option'); o.value = l.id; o.innerText = l.name; sel.appendChild(o); }); };
        window.renderDeleteLessonList = function() { const list = document.getElementById('delete-lesson-list'); list.innerHTML = ''; const discId = document.getElementById('del-lesson-disc-select').value; const lessons = appState.lessons.filter(l => l.disciplineId === discId); lessons.forEach(l => { const d = document.createElement('div'); d.className = "flex justify-between items-center bg-gray-50 dark:bg-slate-700/50 p-2 rounded border dark:border-slate-600"; d.innerHTML = `<span class="text-sm text-gray-700 dark:text-gray-200">${l.name}</span><button onclick="deleteLesson('${l.id}')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm px-2"><i class="fa-solid fa-trash"></i></button>`; list.appendChild(d); }); };
        window.renderDeleteDiscList = function() { const list = document.getElementById('delete-disc-list'); list.innerHTML = ''; appState.disciplines.forEach(d => { const div = document.createElement('div'); div.className = "flex justify-between items-center bg-gray-50 dark:bg-slate-700/50 p-2 rounded border dark:border-slate-600"; div.innerHTML = `<span class="text-sm text-gray-700 dark:text-gray-200">${d.name}</span><button onclick="deleteDiscipline('${d.id}')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm px-2"><i class="fa-solid fa-trash"></i></button>`; list.appendChild(div); }); };
        window.renderBulkDeleteTopicList = function() { const list = document.getElementById('bulk-delete-list'); list.innerHTML = ''; const filterDisc = document.getElementById('del-topic-disc-select').value; const discs = filterDisc === 'all' ? appState.disciplines : appState.disciplines.filter(d => d.id === filterDisc); discs.forEach(d => { const items = appState.items.filter(i => i.disciplineId === d.id); if(items.length > 0) { const h = document.createElement('div'); h.className = 'text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mt-2 mb-1 px-2 py-1 bg-gray-100 dark:bg-slate-800 border-t border-b dark:border-slate-700 sticky top-0 z-10'; h.innerText = d.name; list.appendChild(h); items.forEach(i => { const row = document.createElement('div'); row.className = 'flex items-start gap-2 p-2 hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700/50'; row.innerHTML = `<input type="checkbox" class="delete-topic-checkbox mt-1" value="${i.id}"><label class="text-sm text-gray-700 dark:text-gray-300 flex-1">${i.topic}</label>`; list.appendChild(row); }); } }); };
        window.saveFirebaseConfig = () => { let v = document.getElementById('firebase-config-input').value.trim(); if(!v) return showToast('Cole o código', 'error'); if(v.includes('=')) v = v.split('=')[1].trim(); if(v.endsWith(';')) v = v.slice(0,-1); try { JSON.parse(v); localStorage.setItem('pcpi_firebase_config', v); location.reload(); } catch(e) { try { const f=v.replace(/(^|{|,)\s*([a-zA-Z0-9_]+)\s*:/g, '$1"$2":').replace(/'/g,'"'); JSON.parse(f); localStorage.setItem('pcpi_firebase_config', f); location.reload(); } catch(e2){ showToast('JSON Inválido', 'error'); } } };
        window.toggleSection = (id) => { if (expandedSections.has(id)) expandedSections.delete(id); else expandedSections.add(id); renderSyllabus(); };
        window.addNewLesson = () => { const discId = document.getElementById('new-lesson-disc-select').value; const txt = document.getElementById('new-lesson-name').value; if(!discId) return showToast('Selecione uma disciplina.', 'error'); if(!txt.trim()) return showToast('Digite os nomes das aulas.', 'error'); const names = txt.split('\n').map(t=>t.trim()).filter(t=>t.length>0); if(names.length === 0) return showToast('Nenhuma aula válida.', 'error'); names.forEach((name, i) => { appState.lessons.push({ id: `l_${Date.now()}_${i}`, disciplineId: discId, name: name }); }); saveDataInternal(); document.getElementById('new-lesson-name').value = ''; showToast(`${names.length} aulas criadas!`, 'success'); populateModalSelects(); renderSyllabus(); };
        window.deleteLesson = (lessonId) => { showConfirm('Excluir esta aula e todos os seus tópicos?', () => { appState.items = appState.items.filter(i => i.lessonId !== lessonId); appState.lessons = appState.lessons.filter(l => l.id !== lessonId); saveDataInternal(); renderAll(); renderDeleteLessonList(); showToast('Aula excluída.', 'info'); }); };
        window.addNewTopic = () => { const discId = document.getElementById('new-topic-disc-select').value; const lessonId = document.getElementById('new-topic-lesson-select').value; const txt = document.getElementById('new-topic-name').value; if(!discId || !lessonId) return showToast('Selecione disciplina e aula.', 'error'); if(!txt.trim()) return showToast('Digite os tópicos.', 'error'); const lines = txt.split('\n').map(t=>t.trim()).filter(t=>t.length>0); lines.forEach((t,i) => { appState.items.push({ id: Date.now()+i, disciplineId: discId, lessonId: lessonId, topic: t, status: 'pendente', completedDate: null, reviews: [], note: '' }); }); saveDataInternal(); document.getElementById('new-topic-name').value = ''; showToast('Tópicos adicionados!', 'success'); renderSyllabus(); renderBulkDeleteTopicList(); };
        window.openNoteModal = (id) => { currentEditingId = id; const item = appState.items.find(i => i.id === id); document.getElementById('modal-topic-title').innerText = item.topic; document.getElementById('modal-note-input').value = item.note || ''; document.getElementById('note-modal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); };
        window.closeModal = (id) => { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); if(id==='note-modal') currentEditingId=null; };
        window.toggleReview = (itemId, reviewIndex) => { const item = appState.items.find(i => i.id === itemId); if (item && item.reviews[reviewIndex]) { item.reviews[reviewIndex].done = !item.reviews[reviewIndex].done; checkChallengeProgress('review', 1); saveDataInternal(); renderSyllabus(); } };
        window.addStudyHoursInternal = (val) => { appState.totalHours += val; checkChallengeProgress('hours', val); saveDataInternal(); renderProductivity(); showToast(`+${val} horas registradas!`, 'success'); };
        window.openSyncModal = () => { document.getElementById('sync-modal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); };
        window.openManageModal = () => { populateModalSelects(); renderDeleteDiscList(); renderBulkDeleteTopicList(); document.getElementById('manage-modal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); };
        window.openSettingsModal = () => { document.getElementById('config-title').value = appState.config.title; document.getElementById('config-role').value = appState.config.role; document.getElementById('config-date').value = appState.config.examDate; 
            if(appState.config.startDate) document.getElementById('config-start-date').value = appState.config.startDate;
            document.getElementById('settings-modal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); };
        window.switchTab = (tabId) => { ['tab-add-topic', 'tab-add-lesson', 'tab-add-disc', 'tab-del-disc', 'tab-del-lesson', 'tab-del-topic'].forEach(id => { document.getElementById(id).classList.add('hidden'); document.getElementById('btn-'+id).classList.remove('tab-active'); document.getElementById('btn-'+id).classList.add('tab-inactive'); }); document.getElementById(tabId).classList.remove('hidden'); document.getElementById('btn-'+tabId).classList.add('tab-active'); document.getElementById('btn-'+tabId).classList.remove('tab-inactive'); };
        window.updateStatus = (id, newStatus) => { const item = appState.items.find(i => i.id === id); if (!item) return; item.status = newStatus; if (newStatus === 'concluido') { const today = new Date(); item.completedDate = today.toISOString(); const r1 = new Date(today); r1.setDate(r1.getDate() + 1); const r2 = new Date(today); r2.setDate(r2.getDate() + 7); const r3 = new Date(today); r3.setDate(r3.getDate() + 30); item.reviews = [ { date: r1.toISOString(), done: false, label: '24h' }, { date: r2.toISOString(), done: false, label: '7d' }, { date: r3.toISOString(), done: false, label: '30d' } ]; checkChallengeProgress('items', 1); showToast(`Status atualizado!`, 'success'); } else { item.completedDate = null; item.reviews = []; } saveDataInternal(); renderAll(); };
        window.deleteTopic = (itemId) => { showConfirm('Excluir este tópico?', () => { appState.items = appState.items.filter(i => i.id !== itemId); saveDataInternal(); renderAll(); showToast('Excluído.', 'info'); }); };
        window.saveNote = () => { if (currentEditingId !== null) { const note = document.getElementById('modal-note-input').value; const item = appState.items.find(i => i.id === currentEditingId); if(item) { item.note = note; saveDataInternal(); renderSyllabus(); closeModal('note-modal'); showToast('Salvo!', 'success'); } } };
        window.saveSettings = () => { 
            const title = document.getElementById('config-title').value; 
            const role = document.getElementById('config-role').value; 
            const date = document.getElementById('config-date').value;
            const startDate = document.getElementById('config-start-date').value;
            if(!title || !role || !date) return showToast('Preencha os campos obrigatórios.', 'error'); 
            appState.config = { title, role, examDate: date, startDate: startDate }; 
            saveDataInternal(); renderHeader(); renderGamification(); initCountdown(); closeModal('settings-modal'); showToast('Dados salvos!', 'success'); 
        };
        window.resetHours = () => { showConfirm('Zerar horas estudadas?', () => { appState.totalHours = 0; saveDataInternal(); renderProductivity(); showToast('Zerado.', 'info'); }); };
        window.resetData = () => { showConfirm('ATENÇÃO: Resetar todo o progresso?', () => { appState.totalHours = 0; appState.items.forEach(item => { item.status = 'pendente'; item.completedDate = null; item.reviews = []; }); saveDataInternal(); renderAll(); showToast('Resetado.', 'success'); }); };
        window.filterByDisciplineFromCard = (id) => { expandedSections.add(id); currentFilterDiscipline = id; document.getElementById('filter-discipline').value = id; renderSyllabus(); document.getElementById('syllabus-section').scrollIntoView({ behavior: 'smooth' }); };
        window.filterStatus = (status) => { currentFilterStatus = status; renderSyllabus(); };
        window.deleteDiscipline = (id) => { showConfirm('Apagar disciplina e todo o conteúdo dela?', () => { appState.items = appState.items.filter(i => i.disciplineId !== id); appState.lessons = appState.lessons.filter(l => l.disciplineId !== id); appState.disciplines = appState.disciplines.filter(d => d.id !== id); saveDataInternal(); renderAll(); renderDeleteDiscList(); showToast('Excluída.', 'info'); }); };
        window.deleteSelectedTopics = () => { const cbs = document.querySelectorAll('.delete-topic-checkbox:checked'); if(cbs.length === 0) return showToast('Selecione itens.', 'error'); showConfirm(`Excluir ${cbs.length} tópicos selecionados?`, () => { const ids = Array.from(cbs).map(c => parseInt(c.value)); appState.items = appState.items.filter(i => !ids.includes(i.id)); saveDataInternal(); renderAll(); renderBulkDeleteTopicList(); showToast('Excluídos.', 'info'); }); };
        window.addNewDiscipline = () => { const txt = document.getElementById('new-disc-name').value; if(!txt.trim()) return showToast('Digite nomes.', 'error'); const names = txt.split('\n').map(t=>t.trim()).filter(t=>t.length>0); if(names.length===0) return; let cnt=0; names.forEach((n,i) => { const id = 'custom_'+(Date.now()+i); appState.disciplines.push({id: id, name: n}); appState.lessons.push({id: `l_${id}_01`, disciplineId: id, name: 'Aula 01'}); cnt++; }); saveDataInternal(); document.getElementById('new-disc-name').value=''; showToast(`${cnt} criadas!`, 'success'); populateModalSelects(); renderAll(); switchTab('tab-add-topic'); };
        window.editLessonName = (lessonId, event) => { event.stopPropagation(); const lesson = appState.lessons.find(l => l.id === lessonId); if(!lesson) return; showPrompt('Renomear Aula', lesson.name, (newName) => { lesson.name = newName; saveDataInternal(); renderSyllabus(); populateModalSelects(); renderDeleteLessonList(); showToast('Renomeado!', 'success'); }); };
        
        window.configureScheduleStart = () => {
            const current = appState.config.startDate || new Date().toISOString().split('T')[0];
            showPrompt('Data de Início do Cronograma', current, (newDate) => {
                if(newDate) {
                    appState.config.startDate = newDate;
                    saveDataInternal();
                    renderAll();
                    showToast('Data de início atualizada!', 'success');
                }
            }, 'date');
        };

        window.openPdfModal = () => { document.getElementById('pdf-modal').classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); };

        window.updateStatusIndicator = function(online) { const t = online ? "Online" : "Offline"; const c = online ? "text-green-400" : "text-gray-400"; document.getElementById('header-sync-status').innerText = t; document.getElementById('header-sync-status-mobile').innerText = t; document.getElementById('status-icon-desktop').className = `fa-solid fa-wifi ${c}`; document.getElementById('status-icon-mobile').className = `fa-solid fa-wifi ${c} mr-1`; }
        window.updateSyncUI = function(isActive) { const a = document.getElementById('sync-active-ui'); const s = document.getElementById('sync-setup-ui'); if (isActive) { a.classList.remove('hidden'); s.classList.add('hidden'); document.getElementById('current-sync-id-display').value = currentSyncId; } else { a.classList.add('hidden'); s.classList.remove('hidden'); if(userFirebaseConfig) document.getElementById('firebase-config-input').value = userFirebaseConfig; } }
        window.loadFromSyncId = () => { if(!useFirebase) return showToast("Configure o Firebase primeiro.", 'error'); const newId = document.getElementById('input-sync-id').value.trim(); if(!newId) return; showConfirm("Carregar este ID?", () => { localStorage.setItem('pcpi_sync_id', newId); currentSyncId = newId; setupRealtimeListener(newId); updateSyncUI(true); closeModal('sync-modal'); showToast("Conectando...", "info"); }); };
        window.copySyncId = () => { navigator.clipboard.writeText(currentSyncId).then(() => showToast("Copiado!", "success")); };

        document.getElementById('hours-form').addEventListener('submit', (e) => { e.preventDefault(); const v = parseFloat(document.getElementById('study-input').value); if(!isNaN(v)) { document.getElementById('study-input').value=''; addStudyHoursInternal(v); } });
    </script>
</body>
</html>
